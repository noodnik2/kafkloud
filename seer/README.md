# `seer` - _one that sees_

Seer can tell you things you may not have realized about what's been
communicated in the set of messages sent to a specific topic in Kafkloud.

## Main Idea

Get on-board the AI craze and insert a GPT-like "seer" into the Kafkloud
data pipeline.

The main use case is to "teach" Seer things that it can later recall,
summarize and put into a greater "context" in response to questions
about what it's learned.

### How It Works

In the context of Kafkloud, `seer` receives its input messages on two `streamer`
channels (Kafka topics), and writes its output to another one:

- `seer-statements` - a stream of statements which `seer` "embeds" into its
  understanding of the world, and will use as context when answering questions 
- `seer-questions` - a stream of questions which `seer` will attempt to answer,
  taking into account the context provided in prior messages received
  from `seer-statements`
- `seer-answers` - an output stream of answers generated by `seer` in response
  to questions it's received on `seer-questions`

There are also several HTTP endpoints exposed by the containerized service
created for `seer` (see notes below) that can be used to directly access
and/or control the service deployed as part of Kafkloud.

## Implementation

As of this writing, four Python modules comprise the implementation of the `seer`
Kafkloud component:

1. [seer.py](app/seer.py) - exposes APIs:
   - `accept` - accepts message(s) into `seer`'s context
   - `load` - accepts file(s) whose contents will be added to `seer`'s context
   - `ask` - accepts question(s) which `seer` will attempt to answer
2. [cli.py](app/cli.py) - Command Line Interface (CLI) interface to access `seer` APIs
3. [kafka.py](app/kafka.py) - Kafka (aka `streamer`) interface to access `seer` APIs 
4. [fastapi.py](app/fastapi.py) - Web server exposing both HTTP REST endpoints 
   and the `streamer` interface to access `seer`'s APIs

### Choice of Kafka Client Library
After reading several comparisons of the available options, the
[Confluent Kafka Client](https://docs.confluent.io/platform/current/clients/confluent-kafka-python/html/index.html#kafka-clients)
library was chosen over other alternatives.  Relevant articles considered include:
- [Notes on Kafka in Python](https://matthewrocklin.com/blog/work/2017/10/10/kafka-python)
- [Support for Scalability and Recovery](https://stackoverflow.com/questions/73049329/python-kafka-consumer-library-that-supports-scalability-and-recoverability)
- [Introduction to Confluent Kafka Python Producer](https://www.geeksforgeeks.org/introduction-to-confluent-kafka-python-producer/)
- [Python Kafka Client Benchmarking](http://activisiongamescience.github.io/2016/06/15/Kafka-Client-Benchmarking/)

## Dialogues

Here are some hints about using the various interfaces available for building and
accessing`seer`.

Note that in all cases the appropriate configuration must be provided.  The configuration
is provided via environment variables, and in some cases can be injected via a configuration
file (such as `.env`), depending upon the case / modality.

### Build / Deploy

A typical sequence of [Makefile](./Makefile) targets to be invoked might be
something like:

1. `run[-new]-local` - completely local development/testing
2. `build[-new]-image` - build new docker image
3. `run[-new]-image` - run via docker image
4. `push[-new]-image` - deploy docker image to repository
5. `apply-k8s` - deploy to Kubernetes

### Via CLI

The [CLI](app/cli.py) provides direct access to `seer` APIs; that is, it can't be used to
test the web (i.e., HTTP) or `streamer` interfaces (see below).

Since `seer` uses `chromadb`, you must first start that service before you can 
successfully invoke the `seer` CLI, as exemplified in the dialog below:

```shell
$ : first make sure that the `chromadb` service is running in Docker:
$ docker network create -d bridge kafkloud-backend
$ docker-compose up chromadb --build

$ : suggest using a Python virtual environment; e.g.:
$ conda activate seer
$ pip install -r requirements.txt
 
$ python app/cli.py -v -q "Do you know anything about the Wilymajinkas?"
...
2023-06-28 14:02:39,396 DEBUG: the answer is:  I'm sorry, I don't know anything about the Wilymajinkas.

$ python app/cli.py -v -a "The Wilymajinkas are a tribe of northeastern Native Americans." \
                       -a "They are very tame and should not be feared."
...

$ python app/cli.py -v -q "Do you know anything about the Wilymajinkas?"
...
2023-06-28 14:04:39,565 DEBUG: the answer is:  Yes, I know that the Wilymajinkas are a tribe of northeastern Native Americans who are very tame and should not be feared.
```

### Via HTTP or `streamer` using `docker-compose`

Below are some tips on accessing `seer` using the HTTP and `streamer` interfaces
set up by docker with the [docker-compose](./docker-compose.yml) file.  First,
start the needed services using a dialog like:

```shell
$ docker network create -d bridge kafkloud-backend
$ (cd ../streamer; docker-compose up -d --build)
$ docker-compose up --build
```

- _Note that `streamer` service must be running as well, since the Kafkloud `seer`
  component provides an interface to it as well._

Once the services are running, the following sub-dialogs can be used:

#### HTTP

The [`seer` Tests](./tests/seer_tests.http) include example tests of functionality over the web
(HTTP) interface.  There is an IntelliJ plugin (i.e., "HTTP") that can directly invoke these tests.

### Using `streamer`

Assuming the `kafka-console-producer.sh` and `kafka-console-consumer.sh`
[scripts](https://github.com/kafka-dev/kafka/tree/master/bin)
are accessible, a dialog such as the following could be used to demonstrate
access to `seer`'s APIs via `streamer`:

```shell
$ echo "How do Jukies taste?" | kafka-console-producer.sh –bootstrap-server localhost:9092 –topic seer-question
I don\'t know.
$ echo "Jukies are sweet" | kafka-console-producer.sh –bootstrap-server localhost:9092 –topic seer-statement
$ echo "How do Jukies taste?" | kafka-console-producer.sh –bootstrap-server localhost:9092 –topic seer-question
$ kafka-console-consumer.sh –bootstrap-server localhost:9092 –topic seer-answer
Jukies taste sweet.
```